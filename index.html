
<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>EV Energy Route Planner (Battery-aware)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    body { margin:0; padding:0; font-family: Arial, sans-serif; background:#f0f2f5; }
    .container { display:flex; height:100vh; }
    #map { flex:1; margin:10px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.3); }
    #sidebar { width:360px; padding:18px; overflow:auto; background:#fff; border-left:1px solid #ddd; box-shadow:-2px 0 6px rgba(0,0,0,0.1); }
    h3 { margin-top:0; }
    label { display:block; margin-top:12px; font-weight:600; }
    input[type=text], input[type=number] { width:100%; padding:8px; margin-top:4px; box-sizing:border-box; border:1px solid #ccc; border-radius:4px; }
    button { margin-top:12px; padding:10px 15px; width:100%; border:none; background:#007bff; color:white; font-weight:600; border-radius:4px; cursor:pointer; }
    button:hover { background:#0056b3; }
    .metrics { margin-top:12px; padding:12px; background:#f8f9fa; border:1px solid #ddd; border-radius:4px; }
    .legend { font-size:13px; margin-top:10px; }
    .station-highlight { font-weight:700; color:#d9534f; }
  </style>
</head>
<body>
  <div class="container">
    <div id="map"></div>
    <div id="sidebar">
      <h3>EV Energy Route Planner (Battery-aware)</h3>
      <p>Select <b>Origin</b> and <b>Destination</b> by clicking the map. Enter vehicle & battery info, then press <b>Compute</b>.</p>

      <label>Origin (lat, lon)</label>
      <input id="orig" type="text" placeholder="Click on map to set">

      <label>Destination (lat, lon)</label>
      <input id="dest" type="text" placeholder="Click on map to set">

      <label>Battery Level (%)</label>
      <input id="battery" type="number" value="100" min="1" max="100">

      <label>Vehicle - mass (kg)</label>
      <input id="mass" type="number" value="1500">

      <label>Rolling resistance coefficient C_rr</label>
      <input id="crr" type="number" value="0.01" step="0.001">

      <label>Drag coefficient Cd</label>
      <input id="cd" type="number" value="0.28" step="0.01">

      <label>Frontal area A (m²)</label>
      <input id="A" type="number" value="2.2" step="0.1">

      <label>Default speed (kph)</label>
      <input id="speed" type="number" value="40">

      <button id="compute">Compute Route</button>

      <div class="metrics" id="results">
        <b>Results</b>
        <div id="result_text">No results yet.</div>
        <div class="legend">
          <div><span style="color:green;">■</span> Energy-optimal (when battery allows)</div>
          <div><span style="color:blue;">■</span> Shortest-distance (when battery allows)</div>
          <div><span style="color:orange;">●</span> Charging station</div>
          <div><span style="color:red;">■</span> Route to nearest charger (low battery)</div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const map = L.map('map').setView([12.934968,79.146881], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

    let origMarker = null, destMarker = null;
    let layers = []; // route layers
    let stationMarkers = [];

    map.on('click', function(e){
      if (!origMarker) {
        origMarker = L.marker(e.latlng, {title:"Origin"}).addTo(map).bindPopup("Origin").openPopup();
        document.getElementById('orig').value = `${e.latlng.lat.toFixed(6)},${e.latlng.lng.toFixed(6)}`;
      } else if (!destMarker) {
        destMarker = L.marker(e.latlng, {title:"Destination"}).addTo(map).bindPopup("Destination").openPopup();
        document.getElementById('dest').value = `${e.latlng.lat.toFixed(6)},${e.latlng.lng.toFixed(6)}`;
      } else {
        // reset
        if (origMarker) map.removeLayer(origMarker);
        if (destMarker) map.removeLayer(destMarker);
        layers.forEach(l => map.removeLayer(l)); layers = [];
        stationMarkers.forEach(m => map.removeLayer(m)); stationMarkers = [];
        origMarker = null; destMarker = null;
        document.getElementById('orig').value = ""; document.getElementById('dest').value = "";
      }
    });

    document.getElementById('compute').addEventListener('click', async function(){
      const orig = document.getElementById('orig').value.split(',').map(x => parseFloat(x.trim()));
      const dest = document.getElementById('dest').value.split(',').map(x => parseFloat(x.trim()));
      const battery = parseFloat(document.getElementById('battery').value);
      if (orig.length < 2 || dest.length < 2) {
        alert("Set origin and destination by clicking map.");
        return;
      }

      const vehicle = {
        mass_kg: parseFloat(document.getElementById('mass').value),
        C_rr: parseFloat(document.getElementById('crr').value),
        Cd: parseFloat(document.getElementById('cd').value),
        A: parseFloat(document.getElementById('A').value),
        min_kwh_per_km: 0.08
      };
      const defaults = { speed_kph: parseFloat(document.getElementById('speed').value), regen_eff: 0.6 };

      const payload = { orig: orig, dest: dest, vehicle: vehicle, defaults: defaults, battery_level: battery };

      // clear old
      layers.forEach(l => map.removeLayer(l)); layers = [];
      stationMarkers.forEach(m => map.removeLayer(m)); stationMarkers = [];
      document.getElementById('result_text').innerText = "Computing...";

      try {
        const resp = await fetch('/route', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(payload)
        });
        const data = await resp.json();

        // display stations if any
        if (data.charging_stations && data.charging_stations.length > 0) {
          data.charging_stations.forEach(s => {
            const marker = L.circleMarker([s.lat, s.lon], {radius:6, color:"orange", fillColor:"orange", fillOpacity:0.9})
              .addTo(map)
              .bindPopup(`<b>Charging Station</b><br>lat:${s.lat.toFixed(6)}<br>lon:${s.lon.toFixed(6)}<br>
                ${s.is_nearest ? '<span class="station-highlight">Nearest</span><br>' : '' }
                ${s.on_energy_route ? '<span class="station-highlight">On energy route</span><br>' : ''}
                ${s.on_distance_route ? '<span class="station-highlight">On distance route</span><br>' : ''}`);
            stationMarkers.push(marker);
          });
        }

        let out = "";
        if (data.mode === "full") {
          // show both routes
          if (data.energy_route) {
            const layer = L.geoJSON(data.energy_route.geojson.geometry, { style: { color: "green", weight: 5 } }).addTo(map);
            layers.push(layer);
            const m = data.energy_route.metrics;
            out += `<b>Energy-optimal</b>: ${(m.distance_m/1000).toFixed(2)} km, ${(m.energy_kwh).toFixed(3)} kWh, ${(m.time_s/60).toFixed(1)} min<br>`;
          } else out += "Energy route not found.<br>";

          if (data.distance_route) {
            const layer2 = L.geoJSON(data.distance_route.geojson.geometry, { style: { color: "blue", weight: 4, opacity:0.8 } }).addTo(map);
            layers.push(layer2);
            const md = data.distance_route.metrics;
            out += `<b>Shortest-distance</b>: ${(md.distance_m/1000).toFixed(2)} km, ${(md.energy_kwh).toFixed(3)} kWh, ${(md.time_s/60).toFixed(1)} min<br>`;
          } else out += "Distance route not found.<br>";
        } else if (data.mode === "half") {
          // show both routes and stations; highlight which stations are on which route
          if (data.energy_route) {
            const layer = L.geoJSON(data.energy_route.geojson.geometry, { style: { color: "green", weight: 5 } }).addTo(map);
            layers.push(layer);
            const m = data.energy_route.metrics;
            out += `<b>Energy-optimal</b>: ${(m.distance_m/1000).toFixed(2)} km, ${(m.energy_kwh).toFixed(3)} kWh, ${(m.time_s/60).toFixed(1)} min<br>`;
          } else out += "Energy route not found.<br>";

          if (data.distance_route) {
            const layer2 = L.geoJSON(data.distance_route.geojson.geometry, { style: { color: "blue", weight: 4, opacity:0.8 } }).addTo(map);
            layers.push(layer2);
            const md = data.distance_route.metrics;
            out += `<b>Shortest-distance</b>: ${(md.distance_m/1000).toFixed(2)} km, ${(md.energy_kwh).toFixed(3)} kWh, ${(md.time_s/60).toFixed(1)} min<br>`;
          } else out += "Distance route not found.<br>";
          out += `<i>Charging stations are shown on the map. Stations labeled "On energy route" or "On distance route" indicate the route passes through that station's node.</i><br>`;
        } else if (data.mode === "low") {
          // show only route to nearest station
          if (data.low_battery_route) {
            const layer = L.geoJSON(data.low_battery_route.geojson.geometry, { style: { color: "red", weight: 5 } }).addTo(map);
            layers.push(layer);
            const m = data.low_battery_route.metrics;
            out += `<b>Nearest charging station route</b>: ${(m.distance_m/1000).toFixed(2)} km, ${(m.energy_kwh).toFixed(3)} kWh, ${(m.time_s/60).toFixed(1)} min<br>`;
          } else out += "No reachable charging station found.<br>";
        } else {
          out = "Unknown mode or no data returned.";
        }

        document.getElementById('result_text').innerHTML = out;
      } catch (err) {
        document.getElementById('result_text').innerText = "Error: " + err;
      }
    });
  </script>
</body>
</html>

